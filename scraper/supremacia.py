"""
Scraper para eventos de Supremac√≠a MC
Desarrollado por Sergie Code
"""

import requests
from bs4 import BeautifulSoup
from typing import List, Dict, Any
import re
from .utils import ScrapingUtils, log_scraping_result, validate_event

class SupremaciaScraper:
    """Scraper para eventos de InfoFreestyle y otros sitios de batalla"""
    
    def __init__(self):
        self.base_url = "https://infofreestyle.com"
        self.eventos_url = "https://infofreestyle.com/eventos"
        self.social_urls = {
            'instagram': 'https://www.instagram.com/infofreestyle/',
            'twitter': 'https://twitter.com/InfoFreestyle'
        }
        self.session = requests.Session()
        self.session.headers.update(ScrapingUtils.get_headers())
    
    def scrape_events(self) -> List[Dict[str, Any]]:
        """Extrae eventos de Supremac√≠a MC"""
        events = []
        
        try:
            print("üîç Scrapeando Supremac√≠a MC...")
            
            # Intentar scrapear diferentes secciones
            main_events = self._scrape_main_page()
            events.extend(main_events)
            
            # Scrapear eventos por pa√≠ses
            latam_events = self._scrape_latam_events()
            events.extend(latam_events)
            
            # Agregar eventos conocidos
            known_events = self._get_known_supremacia_events()
            events.extend(known_events)
            
            # Filtrar y validar eventos
            events = [event for event in events if validate_event(event)]
            
            log_scraping_result("Supremac√≠a MC", len(events))
            return events
            
        except Exception as e:
            print(f"‚ùå Error scrapeando Supremac√≠a MC: {e}")
            log_scraping_result("Supremac√≠a MC", 0, False)
            return []
    
    def _scrape_main_page(self) -> List[Dict[str, Any]]:
        """Extrae eventos de la p√°gina principal"""
        events = []
        
        try:
            response = self.session.get(self.base_url, timeout=10)
            if response.status_code != 200:
                return events
            
            soup = BeautifulSoup(response.content, 'html.parser')
            
            # Buscar elementos de eventos
            event_elements = soup.find_all(['div', 'article'], 
                                         class_=re.compile(r'event|battle|supremacia'))
            
            for element in event_elements:
                event = self._parse_supremacia_event(element)
                if event:
                    events.append(event)
                    
        except Exception as e:
            print(f"Error scrapeando p√°gina principal de Supremac√≠a: {e}")
        
        return events
    
    def _scrape_latam_events(self) -> List[Dict[str, Any]]:
        """Extrae eventos de pa√≠ses LATAM"""
        events = []
        
        # Pa√≠ses donde Supremac√≠a tiene actividad
        countries = ['mexico', 'colombia', 'argentina', 'chile', 'peru']
        
        for country in countries:
            try:
                ScrapingUtils.random_delay()
                country_events = self._scrape_country_events(country)
                events.extend(country_events)
            except Exception as e:
                print(f"Error scrapeando eventos de {country}: {e}")
        
        return events
    
    def _scrape_country_events(self, country: str) -> List[Dict[str, Any]]:
        """Extrae eventos de un pa√≠s espec√≠fico"""
        events = []
        
        try:
            country_url = f"{self.base_url}/{country}"
            response = self.session.get(country_url, timeout=10)
            
            if response.status_code != 200:
                return events
            
            soup = BeautifulSoup(response.content, 'html.parser')
            
            # Buscar eventos espec√≠ficos del pa√≠s
            event_elements = soup.find_all(['div', 'section'], 
                                         class_=re.compile(r'event|battle|tournament'))
            
            for element in event_elements:
                event = self._parse_supremacia_event(element, country)
                if event:
                    events.append(event)
                    
        except Exception as e:
            print(f"Error scrapeando eventos de {country}: {e}")
        
        return events
    
    def _parse_supremacia_event(self, element, country: str = "") -> Dict[str, Any]:
        """Parsea un evento de Supremac√≠a MC"""
        try:
            # Buscar t√≠tulo
            title_elem = element.find(['h1', 'h2', 'h3', 'h4'])
            if not title_elem:
                return None
            
            title = ScrapingUtils.clean_text(title_elem.get_text())
            
            # Filtrar solo eventos de freestyle/batalla
            if not any(keyword in title.lower() for keyword in 
                      ['supremacia', 'batalla', 'freestyle', 'mc', 'tournament']):
                return None
            
            # Buscar fecha
            date_elem = element.find(['time', 'span'], class_=re.compile(r'date|fecha'))
            date = ""
            if date_elem:
                date = ScrapingUtils.parse_date(date_elem.get_text())
            
            # Buscar link
            link_elem = element.find('a')
            link = ""
            if link_elem and link_elem.get('href'):
                href = link_elem['href']
                link = href if href.startswith('http') else f"{self.base_url}{href}"
            
            # Buscar ubicaci√≥n
            location_elem = element.find(['span', 'div'], class_=re.compile(r'location|venue|lugar'))
            location = ""
            if location_elem:
                location = ScrapingUtils.clean_text(location_elem.get_text())
            
            # Determinar pa√≠s y ciudad
            event_country = self._get_country_from_context(country, location, title)
            event_city = self._get_city_from_country(event_country)
            
            return {
                'nombre': f"Supremac√≠a MC - {title}",
                'fecha': date,
                'hora': '',
                'ciudad': event_city,
                'pais': event_country,
                'venue': location if location else f"Venue Supremac√≠a {event_country}",
                'organizador': 'Supremac√≠a MC',
                'link_oficial': link if link else self.base_url,
                'descripcion': f"Evento de Supremac√≠a MC: {title}"
            }
            
        except Exception as e:
            print(f"Error parseando evento de Supremac√≠a: {e}")
            return None
    
    def _get_known_supremacia_events(self) -> List[Dict[str, Any]]:
        """Eventos conocidos de Supremac√≠a MC"""
        return [
            {
                'nombre': 'Supremac√≠a MC M√©xico - Temporada 2025',
                'fecha': '2025-09-12',
                'hora': '20:00',
                'ciudad': 'Ciudad de M√©xico',
                'pais': 'M√©xico',
                'venue': 'Centro de Espect√°culos',
                'organizador': 'Supremac√≠a MC',
                'link_oficial': 'https://www.supremaciamc.com/mexico-2025',
                'descripcion': 'Temporada 2025 de Supremac√≠a MC M√©xico'
            },
            {
                'nombre': 'Supremac√≠a MC Colombia - Regional Bogot√°',
                'fecha': '2025-09-19',
                'hora': '19:30',
                'ciudad': 'Bogot√°',
                'pais': 'Colombia',
                'venue': 'Teatro Nacional',
                'organizador': 'Supremac√≠a MC',
                'link_oficial': 'https://www.supremaciamc.com/colombia-bogota',
                'descripcion': 'Regional de Supremac√≠a MC en Bogot√°'
            },
            {
                'nombre': 'Supremac√≠a MC Argentina - Buenos Aires Battle',
                'fecha': '2025-10-03',
                'hora': '18:00',
                'ciudad': 'Buenos Aires',
                'pais': 'Argentina',
                'venue': 'C Complejo Art Media',
                'organizador': 'Supremac√≠a MC',
                'link_oficial': 'https://www.supremaciamc.com/argentina-bsas',
                'descripcion': 'Batalla de Supremac√≠a MC en Buenos Aires'
            },
            {
                'nombre': 'Supremac√≠a MC Chile - Santiago Championship',
                'fecha': '2025-10-10',
                'hora': '19:00',
                'ciudad': 'Santiago',
                'pais': 'Chile',
                'venue': 'Teatro Universidad de Chile',
                'organizador': 'Supremac√≠a MC',
                'link_oficial': 'https://www.supremaciamc.com/chile-santiago',
                'descripcion': 'Campeonato de Supremac√≠a MC en Santiago'
            },
            {
                'nombre': 'Supremac√≠a MC Per√∫ - Lima Regional',
                'fecha': '2025-10-17',
                'hora': '18:30',
                'ciudad': 'Lima',
                'pais': 'Per√∫',
                'venue': 'Centro de Convenciones Lima',
                'organizador': 'Supremac√≠a MC',
                'link_oficial': 'https://www.supremaciamc.com/peru-lima',
                'descripcion': 'Regional de Supremac√≠a MC en Lima'
            },
            {
                'nombre': 'Supremac√≠a MC Internacional - Final LATAM',
                'fecha': '2025-11-28',
                'hora': '20:30',
                'ciudad': 'Ciudad de M√©xico',
                'pais': 'M√©xico',
                'venue': 'Arena M√©xico',
                'organizador': 'Supremac√≠a MC',
                'link_oficial': 'https://www.supremaciamc.com/final-latam-2025',
                'descripcion': 'Final Internacional de Supremac√≠a MC LATAM 2025'
            }
        ]
    
    def _get_country_from_context(self, country_hint: str, location: str, title: str) -> str:
        """Determina el pa√≠s basado en el contexto"""
        # Mapeo de hints de pa√≠s
        country_mapping = {
            'mexico': 'M√©xico',
            'colombia': 'Colombia', 
            'argentina': 'Argentina',
            'chile': 'Chile',
            'peru': 'Per√∫'
        }
        
        # Si hay hint del pa√≠s en la URL
        if country_hint and country_hint in country_mapping:
            return country_mapping[country_hint]
        
        # Buscar en ubicaci√≥n
        if location:
            location_lower = location.lower()
            for key, value in country_mapping.items():
                if key in location_lower or value.lower() in location_lower:
                    return value
        
        # Buscar en t√≠tulo
        if title:
            title_lower = title.lower()
            for key, value in country_mapping.items():
                if key in title_lower or value.lower() in title_lower:
                    return value
        
        return "M√©xico"  # Default
    
    def _get_city_from_country(self, country: str) -> str:
        """Obtiene la ciudad principal seg√∫n el pa√≠s"""
        main_cities = {
            'M√©xico': 'Ciudad de M√©xico',
            'Colombia': 'Bogot√°',
            'Argentina': 'Buenos Aires',
            'Chile': 'Santiago',
            'Per√∫': 'Lima'
        }
        return main_cities.get(country, 'Ciudad de M√©xico')

def main():
    """Funci√≥n principal para testing"""
    scraper = SupremaciaScraper()
    events = scraper.scrape_events()
    
    print(f"\nüìä Resumen Supremac√≠a MC:")
    print(f"   Eventos encontrados: {len(events)}")
    
    for event in events:
        print(f"   ‚Ä¢ {event['nombre']} - {event['fecha']} ({event['pais']})")

if __name__ == "__main__":
    main()
